<div>

    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-lg font-semibold" th:text="${cliente.razonSocial}">Cliente</h2>
            <div class="text-sm text-gray-500">CUIT: <span th:text="${cliente.cuit}"></span></div>
            <div class="text-sm text-gray-500">Email: <span th:text="${cliente.email}"></span></div>
            <div class="text-sm text-gray-500">Condición fiscal: <span th:text="${condicionFiscal}"></span></div>
        </div>
        <a th:href="@{'/facturacion/individual'}" class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 px-3 py-2 rounded-md">Volver</a>
    </div>

    <div class="mb-6">
        <h3 class="font-semibold mb-3">Contratos del cliente</h3>
        <form th:action="@{'/facturacion/cliente/' + ${cliente.id} + '/generar'}" method="post" id="facturarForm">
            <table class="w-full bg-white shadow rounded overflow-hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left text-sm text-gray-600">Sel</th>
                        <th class="p-3 text-left text-sm text-gray-600">ID</th>
                        <th class="p-3 text-left text-sm text-gray-600">Servicio</th>
                        <th class="p-3 text-left text-sm text-gray-600">Fecha inicio</th>
                        <th class="p-3 text-left text-sm text-gray-600">Fecha fin</th>
                        <th class="p-3 text-left text-sm text-gray-600">Precio unitario</th>
                        <th class="p-3 text-left text-sm text-gray-600">Cantidad</th>
                        <th class="p-3 text-left text-sm text-gray-600">Subtotal</th>
                        <th class="p-3 text-left text-sm text-gray-600">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="contrato : ${contratos}" class="border-b hover:bg-gray-50">
                        <td class="p-3"><input type="checkbox" name="contratoIds" th:value="${contrato.id}" class="selbox" onchange="recalcular()" /></td>
                        <td class="p-3" th:text="${contrato.id}"></td>
                        <td class="p-3" th:text="${contrato.servicio.nombre}"></td>
                        <td class="p-3" th:text="${contrato.fechaInicio}"></td>
                        <td class="p-3" th:text="${contrato.fechaFin}"></td>
                        <td class="p-3"><input type="number" step="0.01" readonly th:id="${'precio_' + contrato.id}" th:value="${contrato.importePersonalizado != null ? contrato.importePersonalizado : contrato.servicio.precioBase}" class="w-28 px-2 py-1 border rounded" /></td>
                        <td class="p-3"><input type="number" min="1" value="1" th:name="${'cantidad_' + contrato.id}" th:id="${'cantidad_' + contrato.id}" class="w-20 px-2 py-1 border rounded qty" onchange="recalcular()" /></td>
                        <td class="p-3"><input type="text" readonly th:id="${'subtotal_' + contrato.id}" value="0.00" class="w-28 px-2 py-1 border rounded subtotal" /></td>
                        <td class="p-3" th:text="${contrato.estado}"></td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-4 flex items-center justify-between">
                <div>
                    <button type="submit" class="bg-violet-600 text-white px-4 py-2 rounded">Generar factura</button>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600">Subtotal: <span id="subtotalDisplay">0.00</span></div>
                    <div id="ivaRow" class="text-sm text-gray-600" style="display:none;">IVA (<span id="ivaPercentDisplay">21</span>%): <span id="ivaDisplay">0.00</span></div>
                    <div class="mt-1 text-lg font-semibold">Total: <span id="totalDisplay">0.00</span></div>
                </div>
            </div>
        </form>
    </div>

    <div>
        <p class="text-sm text-gray-500">Para generar una factura, selecciona los contratos/servicios y presiona "Generar factura" (pendiente de implementación).</p>
    </div>

</div>

<script th:inline="javascript">
    function parseDecimal(v) {
        try { return parseFloat(v) || 0; } catch(e) { return 0; }
    }
    function recalcular() {
        let total = 0.0;
        document.querySelectorAll('input.selbox').forEach(cb => {
            if (!cb.checked) {
                const id = cb.value;
                document.getElementById('subtotal_' + id).value = '0.00';
                return;
            }
            const id = cb.value;
            const precio = parseDecimal(document.getElementById('precio_' + id).value);
            const qtyEl = document.getElementById('cantidad_' + id);
            const cantidad = parseInt(qtyEl ? qtyEl.value : '1') || 0;
            const subtotal = precio * cantidad;
            document.getElementById('subtotal_' + id).value = subtotal.toFixed(2);
            total += subtotal;
        });
        document.getElementById('totalDisplay').innerText = total.toFixed(2);
    }

    // mostrar o esconder fila del IVA según la configuración pasada por el servidor
    window.addEventListener('load', function(){
        var showIva = [[${showIva}]];
        var ivaPercent = [[${ivaPercent}]];
        // set displays
        try {
            document.getElementById('ivaPercentDisplay').innerText = parseFloat(ivaPercent).toFixed(2).replace(/\.00$/, '');
        } catch(e) {}
        if (showIva) {
            document.getElementById('ivaRow').style.display = 'block';
        } else {
            document.getElementById('ivaRow').style.display = 'none';
        }

        // enhance recalculation to include IVA when applicable
        const originalRecalc = recalcular;
        window.recalcular = function(){
            let subtotal = 0.0;
            document.querySelectorAll('input.selbox').forEach(cb => {
                if (!cb.checked) {
                    const id = cb.value;
                    document.getElementById('subtotal_' + id).value = '0.00';
                    return;
                }
                const id = cb.value;
                const precio = parseDecimal(document.getElementById('precio_' + id).value);
                const qtyEl = document.getElementById('cantidad_' + id);
                const cantidad = parseInt(qtyEl ? qtyEl.value : '1') || 0;
                const subtotalItem = precio * cantidad;
                document.getElementById('subtotal_' + id).value = subtotalItem.toFixed(2);
                subtotal += subtotalItem;
            });
            document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2);
            let iva = 0.0;
            if (showIva) {
                const ivaDecimal = parseFloat(ivaPercent) / 100.0;
                iva = subtotal * ivaDecimal;
            }
            document.getElementById('ivaDisplay').innerText = iva.toFixed(2);
            const totalWithIva = subtotal + iva;
            document.getElementById('totalDisplay').innerText = totalWithIva.toFixed(2);
        };

        // attach listeners again
        document.querySelectorAll('input.qty').forEach(el => el.addEventListener('change', recalcular));
        document.querySelectorAll('input.selbox').forEach(el => el.addEventListener('change', recalcular));
        // initial run
        recalcular();
    });

    // no duplicate initializers — recalcular ya es invocado above
</script>