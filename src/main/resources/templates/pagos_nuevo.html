<div>

    <!-- Tom Select CSS (select con búsqueda) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css">
    <form id="formPago" method="post" action="/pagos">
        <!-- CSRF token para Spring Security -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700">Buscar cliente</label>
            <select id="clienteSelect" name="clienteId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                <option value="">-- Seleccione un cliente --</option>
                <option th:each="c : ${clientes}"
                    th:value="${c.id}"
                    th:text="${c.razonSocial}"
                    th:attr="data-condicion=${c.condicionFiscal},data-email=${c.email}">
                </option>
            </select>
        </div>

        <div id="clienteDatos" class="mb-6 hidden">
            <h3 class="font-semibold">Cliente seleccionado:</h3>
            <div id="clienteNombre"></div>
            <div id="clienteCondicion"></div>
            <div id="clienteEmail"></div>
        </div>

        <h3 class="font-semibold mb-2">Facturas pendientes</h3>
        <div class="overflow-x-auto mb-4">
            <table id="facturasTable" class="w-full bg-white shadow rounded overflow-hidden hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left text-sm text-gray-600"></th>
                        <th class="p-3 text-left text-sm text-gray-600">Factura</th>
                        <th class="p-3 text-left text-sm text-gray-600">Fecha</th>
                        <th class="p-3 text-left text-sm text-gray-600">Total</th>
                        <th class="p-3 text-left text-sm text-gray-600">Saldo pendiente</th>
                        <th class="p-3 text-left text-sm text-gray-600">Monto a pagar</th>
                    </tr>
                </thead>
                <tbody id="facturasBody"></tbody>
            </table>
        </div>

        <div class="mb-4 text-right">
            <strong>Total aplicado:</strong> <span id="totalAplicado">0</span>
        </div>

        <h3 class="font-semibold mb-2">Métodos de pago</h3>
        <div class="overflow-x-auto mb-4">
            <table id="metodosTable" class="w-full bg-white shadow rounded overflow-hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left text-sm text-gray-600">Método</th>
                        <th class="p-3 text-left text-sm text-gray-600">Monto</th>
                        <th class="p-3 text-left text-sm text-gray-600">Acción</th>
                    </tr>
                </thead>
                <tbody id="metodosBody"></tbody>
            </table>
        </div>

        <div class="flex items-center gap-4 mb-2">
            <button type="button" id="agregarMetodo" class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md">➕ Agregar método de pago</button>
            <div class="ml-auto">Total pagado: <span id="totalPagado">0</span></div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Observaciones</label>
            <input type="text" name="observaciones" id="observacionesInput" class="w-full border rounded px-2 py-1" placeholder="Observaciones (opcional)" />
        </div>

        <div id="errores" class="text-sm text-red-600 mb-4"></div>

        <div class="flex gap-2">
            <button type="submit" id="confirmarBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Confirmar pago</button>
            <a href="/pagos" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md">Cancelar</a>
        </div>

        
    </form>

    <!-- Tom Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

</div>

<script>
    // Inicializar Tom Select para que el select de clientes sea buscable
    try {
        new TomSelect('#clienteSelect', {
            create: false,
            allowEmptyOption: true,
            placeholder: '-- Seleccione un cliente --',
            maxOptions: 100
        });
    } catch(e) {
        console.warn('TomSelect no pudo inicializarse:', e);
    }
    const clienteSelect = document.getElementById('clienteSelect');
    const clienteDatos = document.getElementById('clienteDatos');
    const clienteNombre = document.getElementById('clienteNombre');
    const clienteCondicion = document.getElementById('clienteCondicion');
    const clienteEmail = document.getElementById('clienteEmail');
    const facturasTable = document.getElementById('facturasTable');
    const facturasBody = document.getElementById('facturasBody');
    const totalAplicadoEl = document.getElementById('totalAplicado');
    const metodosBody = document.getElementById('metodosBody');
    const totalPagadoEl = document.getElementById('totalPagado');
    const erroresEl = document.getElementById('errores');
    const formPago = document.getElementById('formPago');

    function pad(n){ return n < 10 ? '0' + n : n }
    function formatDate(dateStr){
        if(!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function formatCurrency(v){
        const n = Number(v || 0);
        try{
            return new Intl.NumberFormat('es-AR',{ style: 'currency', currency: 'ARS', minimumFractionDigits: 2 }).format(n);
        }catch(e){
            return n.toFixed(2);
        }
    }

    clienteSelect.addEventListener('change', async () => {
        const clienteId = clienteSelect.value;
        if (!clienteId) {
            clienteDatos.classList.add('hidden');
            facturasTable.classList.add('hidden');
            facturasBody.innerHTML = '';
            return;
        }

        const opt = clienteSelect.options[clienteSelect.selectedIndex];
        clienteNombre.textContent = 'Nombre: ' + opt.text;
        clienteCondicion.textContent = 'Condición fiscal: ' + (opt.getAttribute('data-condicion') || '-');
        clienteEmail.textContent = 'Email: ' + (opt.getAttribute('data-email') || '-');
        clienteDatos.classList.remove('hidden');

        const res = await fetch('/pagos/facturas?clienteId=' + clienteId);
        if (!res.ok) return;
        const facturas = await res.json();
        facturasBody.innerHTML = '';
        for (const f of facturas) {
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-gray-50';
            tr.setAttribute('data-saldo', f.saldoPendiente || 0);
            tr.innerHTML = `
                <td class="p-3"><input type="checkbox" class="fact-check" name="factura_id" value="${f.id}" /></td>
                <td class="p-3">${f.id}</td>
                <td class="p-3">${formatDate(f.fechaEmision)}</td>
                <td class="p-3">${formatCurrency(f.total)}</td>
                <td class="p-3">${formatCurrency(f.saldoPendiente)}</td>
                <td class="p-3"><input type="number" step="0.01" min="0" name="monto_aplicar_${f.id}" class="ml-2 monto-input border rounded px-2 py-1" disabled data-default="" /></td>
            `;
            facturasBody.appendChild(tr);
        }
        facturasTable.classList.remove('hidden');

        // attach listeners
        document.querySelectorAll('.fact-check').forEach(ch => {
            ch.addEventListener('change', (e) => {
                const val = e.target.value;
                const input = document.querySelector('input[name="monto_aplicar_' + val + '"]');
                if (e.target.checked) {
                    input.disabled = false;
                    input.value = input.getAttribute('data-default') || '';
                } else {
                    input.disabled = true;
                    input.value = '';
                }
                computeTotals();
            });
        });

        document.querySelectorAll('.monto-input').forEach(inp => {
            inp.addEventListener('input', computeTotals);
        });

        computeTotals();
    });

    document.getElementById('agregarMetodo').addEventListener('click', () => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="p-3">
                <select name="metodo_pago[]" class="border rounded px-2 py-1">
                    <option value="EFECTIVO">EFECTIVO</option>
                    <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                    <option value="TARJETA">TARJETA</option>
                    <option value="DEPOSITO">DEPOSITO</option>
                    <option value="OTRO">OTRO</option>
                </select>
            </td>
            <td class="p-3"><input name="metodo_monto[]" type="number" step="0.01" min="0" class="border rounded px-2 py-1 metodo-monto" value="0" /></td>
            <td class="p-3"><button type="button" class="removeMetodo bg-red-100 px-2 py-1 rounded">Eliminar</button></td>
        `;
        metodosBody.appendChild(tr);
        tr.querySelector('.removeMetodo').addEventListener('click', () => { tr.remove(); computeTotals(); });
        tr.querySelector('.metodo-monto').addEventListener('input', computeTotals);
    });

    function computeTotals() {
        let totalAplicado = 0.0;
        document.querySelectorAll('.monto-input').forEach(inp => {
            if (inp.disabled) return;
            const v = parseFloat(inp.value || 0);
            if (!isNaN(v)) totalAplicado += v;
        });
        totalAplicadoEl.textContent = formatCurrency(totalAplicado);

        let totalPagado = 0.0;
        document.querySelectorAll('input[name="metodo_monto[]"]').forEach(inp => {
            const v = parseFloat(inp.value || 0);
            if (!isNaN(v)) totalPagado += v;
        });
        totalPagadoEl.textContent = formatCurrency(totalPagado);
    }

    formPago.addEventListener('submit', (e) => {
        erroresEl.textContent = '';
        const clienteId = clienteSelect.value;
        if (!clienteId) { erroresEl.textContent = 'Debe seleccionar un cliente.'; e.preventDefault(); return; }

        const checked = Array.from(document.querySelectorAll('.fact-check')).filter(c => c.checked);
        if (checked.length === 0) { erroresEl.textContent = 'Debe seleccionar al menos una factura.'; e.preventDefault(); return; }

        let totalAplicado = 0.0;
        for (const c of checked) {
            const id = c.value;
            const inp = document.querySelector('input[name="monto_aplicar_' + id + '"]');
            const monto = parseFloat(inp.value || 0);
            const saldo = parseFloat(c.closest('tr').dataset.saldo || 0);
            if (isNaN(monto) || monto < 0.01) { erroresEl.textContent = 'El monto a pagar debe ser al menos $0.01 por factura.'; e.preventDefault(); return; }
            if (monto > saldo) { erroresEl.textContent = 'El monto ingresado no puede superar el saldo pendiente de la factura ' + id + '.'; e.preventDefault(); return; }
            totalAplicado += monto;
        }

        const metodoMontos = Array.from(document.querySelectorAll('input[name="metodo_monto[]"]')).map(i => parseFloat(i.value || 0));
        if (metodoMontos.length === 0) { erroresEl.textContent = 'Debe agregar al menos un método de pago.'; e.preventDefault(); return; }
        const totalPagado = metodoMontos.reduce((a,b) => a + (isNaN(b) ? 0 : b), 0);
        if (Math.abs(totalPagado - totalAplicado) > 0.005) { erroresEl.textContent = `El monto total ingresado en los métodos (${formatCurrency(totalPagado)}) no coincide con el total aplicado a las facturas (${formatCurrency(totalAplicado)}).`; e.preventDefault(); return; }

        // todo ok
    });

</script>
