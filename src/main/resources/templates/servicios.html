<div>

    <div class="flex items-center justify-between gap-4 mb-4">
        <div class="flex-1">
            <input id="servicioSearch" type="search" placeholder="Buscar por nombre..." class="w-full px-3 py-2 border rounded-md" />
        </div>
        <div class="shrink-0">
            <a href="/servicios/nuevo" class="inline-flex items-center gap-2 bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-md shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nuevo Servicio
            </a>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full bg-white shadow rounded overflow-hidden">
            <thead class="bg-gray-50">
                <tr>
                    <th class="p-3 text-left text-sm text-gray-600">ID</th>
                    <th class="p-3 text-left text-sm text-gray-600">Nombre</th>
                    <th class="p-3 text-left text-sm text-gray-600">Precio Base</th>
                    <th class="p-3 text-left text-sm text-gray-600">Acciones</th>
                </tr>
            </thead>
            <tbody id="serviciosTbody">
                <tr th:each="servicio : ${servicios}" class="border-b hover:bg-gray-50">
                    <td class="p-3" th:text="${servicio.id}"></td>
                    <td class="p-3" th:text="${servicio.nombre}"></td>
                    <td class="p-3 monto-cell" th:attr="data-amount=${servicio.precioBase}" th:text="${servicio.precioBase}"></td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <a th:href="@{'/servicios/editar/' + ${servicio.id}}" class="text-sm text-blue-600 hover:underline">Editar</a>
                            <a href="#" th:attr="data-url=@{'/servicios/eliminar/' + ${servicio.id}}" class="text-sm text-red-600 hover:underline" onclick="confirmEliminar(this)">Eliminar</a>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="mt-2 flex justify-end text-sm text-gray-500">
        Total: <span class="ml-2" id="serviciosCount" th:text="${servicios.size()}">0</span>
    </div>

<script>
    // formatea las celdas de precio a formato moneda
    (function(){
        try{
            const fmt = new Intl.NumberFormat('es-AR',{ style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
            document.querySelectorAll('.monto-cell').forEach(td => {
                const a = td.getAttribute('data-amount');
                const n = Number(a || 0);
                td.textContent = fmt.format(isNaN(n) ? 0 : n);
            });
        }catch(e){/* no bloquear si falla */}
    })();

    function confirmEliminar(el) {
        var url = el.getAttribute('data-url');
        if (!confirm('¿Confirmar eliminación del servicio?')) return false;
        window.location.href = url;
    }

    // Dynamic search for servicios
    (function(){
        function debounce(fn, wait){
            let t;
            return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); }
        }

        function escapeHtml(str){ return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; }); }

        function formatMoney(n){
            try{ return new Intl.NumberFormat('es-AR',{ style: 'currency', currency: 'ARS', minimumFractionDigits: 2 }).format(n);
            }catch(e){ return n; }
        }

        function renderRows(list){
            const tbody = document.getElementById('serviciosTbody'); if(!tbody) return;
            tbody.innerHTML = '';
            (list || []).forEach(s => {
                const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50';
                const id = s.id || '';
                const nombre = escapeHtml(s.nombre || '');
                const precio = typeof s.precioBase === 'number' ? formatMoney(s.precioBase) : formatMoney(Number(s.precioBase || 0));
                tr.innerHTML = `
                    <td class="p-3">${id}</td>
                    <td class="p-3">${nombre}</td>
                    <td class="p-3">${precio}</td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <a href="/servicios/editar/${id}" class="text-sm text-blue-600 hover:underline">Editar</a>
                            <a href="#" data-url="/servicios/eliminar/${id}" class="text-sm text-red-600 hover:underline" onclick="confirmEliminar(this)">Eliminar</a>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            const cnt = document.getElementById('serviciosCount'); if(cnt) cnt.textContent = (list || []).length;
        }

        const input = document.getElementById('servicioSearch'); if(!input) return;
        const doSearch = debounce(function(){
            const q = input.value.trim();
            const url = '/servicios/search' + (q ? ('?q=' + encodeURIComponent(q)) : '');
            fetch(url).then(r => r.ok ? r.json() : Promise.reject(r)).then(data => renderRows(data)).catch(()=>{});
        }, 300);
        input.addEventListener('input', doSearch);
    })();
</script>

</div>
