<div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <label for="estadoFilter" class="text-sm text-gray-600">Estado</label>
                <select id="estadoFilter" class="text-sm px-2 py-1 w-36 border rounded">
                    <option value="todas">Todas</option>
                    <option value="Emitida">Emitida</option>
                    <option value="Pagado">Pagado</option>
                    <option value="Parcial">Parcial</option>
                </select>
            </div>

            <div class="flex items-center gap-4">
                <a href="/facturacion/individual" class="inline-flex items-center gap-2 bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-md shadow">
                    Facturación Individual
                </a>
                <a href="#" id="openMassModal" class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-200">
                    Facturación Masiva
                </a>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full bg-white shadow rounded overflow-hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left text-sm text-gray-600">ID</th>
                        <th class="p-3 text-left text-sm text-gray-600">Cliente</th>
                        <th class="p-3 text-left text-sm text-gray-600">Tipo</th>
                        <th class="p-3 text-left text-sm text-gray-600">Fecha</th>
                        <th class="p-3 text-left text-sm text-gray-600">Total</th>
                        <th class="p-3 text-left text-sm text-gray-600">Estado</th>
                        <th class="p-3 text-left text-sm text-gray-600">Detalle</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="comp : ${comprobantes}" class="border-b hover:bg-gray-50">
                        <td class="p-3" th:text="${comp.id}"></td>
                        <td class="p-3" th:text="${comp.cliente.razonSocial}"></td>
                        <td class="p-3" th:text="${comp.tipoComprobante}"></td>
                        <td class="p-3" th:text="${#temporals.format(comp.fechaEmision, 'dd/MM/yyyy')}"></td>
                        <td class="p-3 monto-cell" th:attr="data-amount=${comp.total}" th:text="${comp.total}"></td>
                        <td class="p-3 estado-cell">
                            <span class="inline-block px-2 py-1 rounded text-white text-xs" th:classappend="${comp.estado == 'Pagado' ? ' bg-green-600' : (comp.estado == 'Parcial' ? ' bg-yellow-500' : (comp.estado == 'Emitida' ? ' bg-violet-600' : ' bg-gray-500')) }" th:text="${comp.estado}"></span>
                        </td>
                        <td class="p-3">
                            <a th:href="@{/facturacion/{id}(id=${comp.id})}" th:attr="data-id=${comp.id}" href="#" class="text-blue-600 hover:underline openDetail">Ver</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-2 flex justify-end text-sm text-gray-500">
            Total filas: <span id="totalCount" class="ml-2 font-medium" th:text="${comprobantes.size()}">0</span>
        </div>

        <!-- Modal Facturación Masiva -->
        <div id="massModal" class="fixed inset-0 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">Facturación Masiva</h3>
                    <button id="closeMassModal" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>
                <div id="massModalBody">
                    <!-- contenido provisional: en blanco por ahora -->
                </div>
            </div>
        </div>

        <!-- Modal Detalle Comprobante -->
        <div id="detailModal" class="fixed inset-0 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-3xl p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">Detalle de Comprobante</h3>
                    <button id="closeDetailModal" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>
                <div id="detailModalBody">
                    <!-- contenido cargado via fetch -->
                </div>
            </div>
        </div>

        <script th:inline="none">
            (function(){
                try{
                    const fmt = new Intl.NumberFormat('es-AR',{ style: 'currency', currency: 'ARS', minimumFractionDigits: 2 });
                    document.querySelectorAll('.monto-cell').forEach(td => {
                        const a = td.getAttribute('data-amount');
                        const n = Number(a || 0);
                        td.textContent = fmt.format(isNaN(n) ? 0 : n);
                    });
                }catch(e){/* no bloquear si falla */}
            })();

            // Modal Facturación Masiva (apertura/cierre sencillo)
            (function(){
                const openBtn = document.getElementById('openMassModal');
                const modal = document.getElementById('massModal');
                const closeBtn = document.getElementById('closeMassModal');

                function showModal(){ modal.classList.remove('hidden'); }
                function hideModal(){ modal.classList.add('hidden'); }

                if(openBtn){ openBtn.addEventListener('click', function(e){ e.preventDefault(); showModal();
                        // fetch preview data and render inside modal
                        fetch('/facturacion/masiva/preview')
                            .then(r => r.ok ? r.json() : Promise.reject(r))
                            .then(data => {
                                const body = document.getElementById('massModalBody');
                                const periodo = data.periodo || (() => { const d = new Date(); return String(d.getMonth()+1).padStart(2,'0')+"/"+d.getFullYear(); })();
                                const primeros = data.primerosClientes || [];
                                body.innerHTML = `
                                    <div class="mb-4">
                                        <h4 class="font-semibold">Facturación Masiva - Resumen</h4>
                                        <div class="text-sm text-gray-600 mt-2">Periodo: ${periodo}</div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>Clientes activos: <strong>${data.clientesActivos}</strong></div>
                                        <div>Clientes ya facturados: <strong>${data.clientesConFacturaDelPeriodo}</strong></div>
                                        <div>Se generarán: <strong>${data.seGeneraran} comprobantes</strong></div>
                                    </div>
                                    <hr class="my-4" />
                                    <div>
                                        <h5 class="font-medium">Primeros ${primeros.length} clientes a facturar:</h5>
                                        <ul class="list-disc list-inside text-sm mt-2">
                                            ${primeros.map(p => `
                                                <li>
                                                    ${p.clienteNombre}
                                                    ${p.applyIva ? '<span class="inline-block ml-2 text-xs px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">Aplica IVA</span>' : ''}
                                                    ${p.tipoComprobante ? '<span class="inline-block ml-2 text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-800">Tipo: ' + p.tipoComprobante + '</span>' : ''}
                                                    <span class="text-xs text-gray-500">(${p.condicionFiscal || ''})</span>
                                                    — Contrato(s) #${(p.contratoIds||[]).join(', #')}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-6">
                                        <button id="massCancelBtn" class="px-3 py-2 bg-gray-100 rounded">Cancelar</button>
                                        <button id="massConfirmBtn" class="px-3 py-2 bg-violet-600 text-white rounded">Confirmar</button>
                                    </div>
                                `;

                                // wire buttons
                                const cancel = document.getElementById('massCancelBtn');
                                const confirm = document.getElementById('massConfirmBtn');
                                if(cancel) cancel.addEventListener('click', function(e){ e.preventDefault(); hideModal(); });
                                if(confirm) confirm.addEventListener('click', function(e){
                                    e.preventDefault();
                                    // submit to create the FacturacionMasiva (simple POST)
                                    const form = document.createElement('form');
                                    form.method = 'POST';
                                    form.action = '/facturacion/masiva';
                                    // periodo for POST: use YYYY-MM format
                                    const periodoPost = (() => { const d = new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); })();
                                    const inpPeriodo = document.createElement('input'); inpPeriodo.type = 'hidden'; inpPeriodo.name = 'periodo'; inpPeriodo.value = periodoPost; form.appendChild(inpPeriodo);
                                    const inpUsuario = document.createElement('input'); inpUsuario.type = 'hidden'; inpUsuario.name = 'usuario'; inpUsuario.value = 'web'; form.appendChild(inpUsuario);
                                    // agregar token CSRF desde meta tags para que Spring Security acepte el POST
                                    try {
                                        const csrfParamMeta = document.querySelector('meta[name="_csrf_parameter"]');
                                        const csrfTokenMeta = document.querySelector('meta[name="_csrf_token"]');
                                        if (csrfParamMeta && csrfTokenMeta) {
                                            const inpCsrf = document.createElement('input');
                                            inpCsrf.type = 'hidden';
                                            inpCsrf.name = csrfParamMeta.getAttribute('content');
                                            inpCsrf.value = csrfTokenMeta.getAttribute('content');
                                            form.appendChild(inpCsrf);
                                        }
                                    } catch(e) { /* ignore */ }
                                    document.body.appendChild(form);
                                    form.submit();
                                });
                            })
                            .catch(err => {
                                const body = document.getElementById('massModalBody');
                                body.innerHTML = '<div class="text-red-600">Error obteniendo la simulación. Intente nuevamente.</div>';
                            });
                    }); }
                if(closeBtn){ closeBtn.addEventListener('click', function(e){ e.preventDefault(); hideModal(); }); }

                // click fuera del diálogo cierra modal
                if(modal){
                    modal.addEventListener('click', function(e){
                        if(e.target === modal){ hideModal(); }
                    });
                }
            })();

            // Modal detalle comprobante (fetch fragment and show)
            (function(){
                const links = document.querySelectorAll('.openDetail');
                const modal = document.getElementById('detailModal');
                const body = document.getElementById('detailModalBody');
                const closeBtn = document.getElementById('closeDetailModal');
                function show(){ if(modal) modal.classList.remove('hidden'); }
                function hide(){ if(modal) modal.classList.add('hidden'); if(body) body.innerHTML=''; }

                links.forEach(a => {
                    a.addEventListener('click', function(e){
                        e.preventDefault();
                        const id = this.getAttribute('data-id');
                        if(!id) return;
                        show();
                        if(body) body.innerHTML = '<div class="p-4 text-sm text-gray-500">Cargando...</div>';
                        fetch('/facturacion/' + id + '/fragment')
                            .then(r => r.ok ? r.text() : Promise.reject(r))
                            .then(html => { if(body) body.innerHTML = html; })
                            .catch(err => { if(body) body.innerHTML = '<div class="text-red-600">Error cargando detalle.</div>'; });
                    });
                });

                if(closeBtn) closeBtn.addEventListener('click', function(e){ e.preventDefault(); hide(); });
                if(modal){ modal.addEventListener('click', function(e){ if(e.target === modal) hide(); }); }
            })();

            // Filtro dinámico por estado (cliente-side)
            (function(){
                const select = document.getElementById('estadoFilter');
                const totalEl = document.getElementById('totalCount');
                if(!select) return;

                function updateVisibleCount(){
                    const rows = document.querySelectorAll('tbody tr');
                    let visible = 0;
                    rows.forEach(r => { if(r.style.display !== 'none') visible++; });
                    if(totalEl) totalEl.textContent = String(visible);
                }

                function applyFilter(){
                    const val = (select.value || 'todas').toLowerCase();
                    const rows = document.querySelectorAll('tbody tr');
                    rows.forEach(r => {
                    const estadoTd = r.querySelector('td.estado-cell span');
                        const text = estadoTd ? estadoTd.textContent.trim().toLowerCase() : '';
                        if(val === 'todas' || text === val){
                            r.style.display = '';
                        } else {
                            r.style.display = 'none';
                        }
                    });
                    updateVisibleCount();
                }

                select.addEventListener('change', applyFilter);
                // asegurar contador correcto al cargar
                document.addEventListener('DOMContentLoaded', updateVisibleCount);
            })();
        </script>
    </div>
</div>